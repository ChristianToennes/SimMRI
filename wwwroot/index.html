<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="./favicon.ico">
    <title>Virtual MRI</title>
    <script src="./vmri.js"></script>
    <link rel="stylesheet" href="./custom.css" />
</head>

<body class="text-monospace" onload="fillDatasets()">
    <div class="main">
        <div class="top-row px-4">
            <button class="btn-primary" onclick="loadFuzzyDataSet()"
                value="Load Dataset" id="loadDataset">Load Dataset: </button>
            <select id="datasetPath" onchange="changedDataset()"></select>
            <a id="datasetURL" class="nav-item cp1s1"></a>
            <div class="ml-2 spinner-border hidden" role="status" id="datasetLoading">
                <span class="sr-only">Loading...</span>
            </div>
            <div class="flex-fill"></div>
            <p class="h-100 mr-3 nav-item"><a class="cp1" href="https://github.com/ChristianToennes/VMRI">Source Code</a></p>
            <h1 class="cp1">Virtual MRI</h1>
        </div>
        <div class="content px-4 pt-2 hidden" id="content">
            <div class="row hidden" id="dataset" onwheel="scrollDataset(event)">
                <figure class="col pr-0 figure text-center">
                    <figcaption class="figure-caption">Proton density</figcaption>
                    <canvas class="figure-img img-fluid rounded" id="imgPD"></canvas>
                </figure>
                <figure class="col pl-0 pr-0 figure text-center">
                    <figcaption class="figure-caption">T1 time</figcaption>
                    <canvas class="figure-img img-fluid rounded" id="imgT1"></canvas>
                </figure>
                <figure class="col pl-0 figure text-center">
                    <figcaption class="figure-caption">T2 time</figcaption>
                    <canvas class="figure-img img-fluid rounded" id="imgT2"></canvas>
                </figure>
                <figure class="col pl-0 figure text-center">
                    <figcaption class="figure-caption">T2* time</figcaption>
                    <canvas class="figure-img img-fluid rounded" id="imgT2s"></canvas>
                </figure>
            </div>
            <div class="row mx-1 hidden" id="dataset_slider">
                <div class="col-auto">
                    <label class="mb-0 py-1 align-self-center" for="slice">Slice:</label>
                </div>
                <div class="col">
                    <input type="range" class="pl-0 pr-0 align-self-center form-control form-control-range" min="0"
                        max="zdim" name="slice" id="slice" value="100" onchange="displayDataSet();" />
                </div>
            </div>
            
            <div class="row mt-2" onkeydown="sequenceParametersKeyDown(event)">
                <div class="col" id="params-general">
                    <div class="form-row">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">X-Dimensions:</label>
                        </div>
                        <input class="col-sm form-control" type="number" min="1" max="256" value="256" name="xdim" id="xdim" oninput="updateTime()" />
                    </div>
                    <div class="form-row">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Y-Dimensions:</label>
                        </div>
                        <input class="col-sm form-control" type="number" min="1", max="256" value="256" name="ydim" id="ydim" oninput="updateTime()" />
                    </div>
                    <div class="form-row">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Z-Dimensions:</label>
                        </div>
                        <input class="col-sm form-control" type="number" min="1", max="256" value="256" name="zdim" id="zdim" oninput="updateTime()" />
                    </div>
                    <div class="form-row">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Interpolation Mode:</label>
                        </div>
                        <select class="col-sm form-control" type="select" id="nearest" name="nearest" oninput="updateTime()">
                             <option value="0">Nearest Neigbhbour</option>
                             <option value="1">Linear Interpolation, 8 Nearest Neighbours</option>
                             <option value="2" selected>Average</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Noise:</label>
                        </div>
                        <select class="col-sm form-control" type="select" id="img_noise_type" name="img_noise_type" oninput="updateTime()">
                             <option value="0" selected>No Noise</option>
                             <!--<option value="1">Gaussian Noise in Image Domain</option>-->
                             <option value="2">Gaussian Noise in Frequency Domain</option>
                        </select>
                        <div class="col-auto ml-4">
                            <label class="mb-0 align-self-center">Mean:</label>
                        </div>
                        <input class="col-sm form-control" type="number" value="0" name="img_noise_mean" id="img_noise_mean" oninput="updateTime()" />
                        <div class="col-auto ml-4">
                            <label class="mb-0 align-self-center">SD:</label>
                        </div>
                        <input class="col-sm form-control" type="number" min="0" value="10" name="img_noise_sigma" id="img_noise_sigma" oninput="updateTime()" />
                    </div>
                    <div class="form-row hidden">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Compressed Sensing:</label>
                        </div>
                        <select class="col-sm form-control" type="select" id="cs" name="cs" oninput="updateTime()">
                            <option value="0" selected>Disable</option>
                            <option value="1">Only K-Space Filter</option>
                            <option value="2">Full</option>
                       </select>
                    </div>
                    <div class="form-row hidden">
                        <div class="col-auto w-25">
                            <label class="mb-0 align-self-center">Parallel Imaging:</label>
                        </div>
                        <input class="col-sm form-control" type="number" value="1" name="parallel" id="parallel" oninput="updateTime()" />
                    </div>
                </div>
            </div>
            <div class="row mt-2" onkeydown="sequenceParametersKeyDown(event)">
                <div class="col" id="sequence">
                    <div class="row">
                        <div class="col nav nav-tabs">
                            <div class="nav-link active" id="params-IR-tab" onclick="setSequence('IR')">Inversion
                                Recovery</div>
                            <div class="nav-link" id="params-SE-tab" onclick="setSequence('SE')">Spin Echo</div>
                            <div class="nav-link" id="params-bSSFP-tab" onclick="setSequence('bSSFP')">Balanced SSFP</div>
                            <div class="nav-link" id="params-FISP-tab" onclick="setSequence('FISP')">FISP</div>
                            <div class="nav-link" id="params-PSIF-tab" onclick="setSequence('PSIF')">PSIF</div>
                            <div class="nav-link" id="params-SGRE-tab" onclick="setSequence('SGRE')">Spoiled GRE</div>
                            <div class="" style="flex-grow: 4"></div>
                            <div class="nav-link" id="params-Na-tab" onclick="setSequence('Na')">Natrium</div>
                            <div class="nav-link" id="params-SQ-tab" onclick="setSequence('SQ')">Na SQ</div>
                            <div class="nav-link" id="params-TQ-tab" onclick="setSequence('TQ')">Na TQ</div>
                            <div class="nav-link" id="params-TQSQR-tab" onclick="setSequence('TQSQR')">Na TQ/SQ</div>
                            <div class="nav-link" id="params-TQF-tab" onclick="setSequence('TQF')">Na TQF</div>
                        </div>
                    </div>
                    <div class="row border py-2 tab-content" id="params">
                        <div class="col tab-pane active" id="params-IR">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TI:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="420" name="ti" id="ir_ti" oninput="updateTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="23" name="te" id="ir_te" oninput="updateTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="666" name="tr" id="ir_tr" oninput="updateTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="ir_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-SE">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="420" name="te" id="se_te" oninput="updateSETime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="666" name="tr" id="se_tr" oninput="updateSETime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="se_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-bSSFP">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="42" name="te" id="bssfp_te" oninput="updateBalancedSSFPTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="84" name="tr" id="bssfp_tr" disabled/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">FA:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="23" min="-180" max="180" name="fa" id="bssfp_fa" oninput="updateBalancedSSFPTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="bssfp_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-FISP">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="15" name="te" id="fisp_te" oninput="updateFISPTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="50" name="tr" id="fisp_tr" oninput="updateFISPTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">FA:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="70" min="-180" max="180" name="fa" id="fisp_fa" oninput="updateFISPTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="fisp_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-PSIF">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="42" name="te" id="psif_te" oninput="updatePSIFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="84" name="tr" id="psif_tr" oninput="updatePSIFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">FA:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="23" min="-180" max="180" name="fa" id="psif_fa" oninput="updatePSIFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="psif_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-SGRE">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="42" name="te" id="sgre_te" oninput="updateSGRETime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="666" name="tr" id="sgre_tr" oninput="updateSGRETime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">FA:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="23" min="-180" max="180" name="fa" id="sgre_fa" oninput="updateSGRETime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="sgre_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-Na">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="1" name="te" id="na_te" oninput="updateNaTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TR:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="666" name="tr" id="na_tr" oninput="updateNaTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">Total Measuring Time:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="na_time"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-SQ">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">τ1 (Default: 10):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="10" name="tau1" id="sq_tau1" oninput="updateSQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE Start:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="1" name="te_start" id="sq_te_start" oninput="updateSQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE End:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="1" name="te_end" id="sq_te_end" oninput="updateSQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE Step:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="1" name="te_step" id="sq_te_step" oninput="updateSQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TEs:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="sq_te"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-TQ">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">τ1 (Default: 10):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="10" name="tau1" id="tq_tau1" oninput="updateTQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">τ2 (Default: 0.1):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="0.1" name="tau2" id="tq_tau2" oninput="updateTQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE Start:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="2" name="te_start" id="tq_te_start" oninput="updateTQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE End:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="3" name="te_end" id="tq_te_end" oninput="updateTQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE Step:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="1" name="te_step" id="tq_te_step" oninput="updateTQTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TEs:</label>
                                </div>
                                <p class="col-sm form-control mb-0" id="tq_te"></p>
                            </div>
                        </div>
                        <div class="col tab-pane" id="params-TQSQR">
                        </div>
                        <div class="col tab-pane" id="params-TQF">
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">TE:</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="2" name="te" id="tqf_te" oninput="updateTQFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">τ1 (Default: 0.01):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="0.01" name="tau1" id="tqf_tau1" oninput="updateTQFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">τ2 (Default: 0.0001):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="0.0001" name="tau2" id="tqf_tau2" oninput="updateTQFTime()"/>
                            </div>
                            <div class="form-row">
                                <div class="col-auto w-25">
                                    <label class="mb-0 align-self-center">FA (Default 90):</label>
                                </div>
                                <input class="col-sm form-control" type="number" value="90" name="fa" id="tqf_fa" oninput="updateTQFTime()"/>
                            </div>
                        </div>
                    </div>
                    <div class="row mx-2 my-2">
                        <input type="button" class="col btn-primary" onclick="startScan()" value="Start Scan"
                            id="sequence_start" />
                    </div>
                </div>
            </div>

            <div class="row pb-2 pt-3 hidden" id="scanningSpinner">
                <div class="flex-fill"></div>
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="flex-fill"></div>
            </div>

            <div class="row pt-3 hidden align-items-start" id="result">
                <div class="col-3">
                    <figure>
                        <div class="figcaption mb-1">K-Space</div>
                        <canvas class="border img-fluid w-100" onwheel="scrollResult(event)" id="kResult"></canvas>
                    </figure>
                    <fieldset id="kspace">
                        <label for="slice">K-Space brighten:</label>
                        <input type="range" class="pl-0 pr-0 form-control form-control-range" min="1" max="100"
                            name="kspacemult" id="kspacemult" value="20" onchange="displayAndWindow3DImage();" />

                        <label for="slice">K-Space y-lines:</label>
                        <input type="number" id="k_yline_number" class="form-control" min="1" max="256" value="256"
                            onchange="reco(true, true);" />
                        <input type="range" class="pl-0 pr-0 form-control form-control-range" min="1" max="256"
                            name="k_yline" id="k_yline" value="256" onchange="reco(false, true);" />
                        <label for="slice">K-Space x-lines:</label>
                        <input type="number" id="k_xline_number" class="form-control" min="1" max="256" value="256"
                            onchange="reco(true, true);" />
                        <input type="range" class="pl-0 pr-0 form-control form-control-range" min="1" max="256"
                            name="k_xline" id="k_xline" value="256" onchange="reco(false, true);" />

                        <label for="slice">K-Space f min:</label>
                        <input type="number" id="k_fmin_number" class="form-control" min="0" max="256" value="0"
                            onchange="reco(true, true);" />
                        <input type="range" class="pl-0 pr-0 form-control form-control-range" min="0" max="128"
                            name="k_fmin" id="k_fmin" value="0" onchange="reco(false, true);" />
                        <label for="slice">K-Space f max:</label>
                        <input type="number" id="k_fmax_number" class="form-control" min="0" max="256" value="256"
                            onchange="reco(true, true);" />
                        <input type="range" class="pl-0 pr-0 form-control form-control-range" min="0" max="256"
                            name="k_fmax" id="k_fmax" value="256" onchange="reco(false, true);" />

                        <input class="btn btn-secondary w-100" type="button" name="reco" id="reco" onclick="reco()"
                            value="Reconstruct image" />
                    </fieldset>
                </div>
                <div class="col mb-2">
                    <div class="row w-100 container-fluid justify-content-center">
                        <canvas class="border img-result w-100"
                            style="max-height: calc(100vh - 8.5rem); max-width: calc(100vh - 8.5rem);"
                            onwheel="scrollResult(event)" onmousedown="startWindowing()" onmouseup="endWindowing()"
                            onmouseout="endWindowing()" onmousemove="windowResult(event)" id="imgResult"></canvas>
                    </div>
                    <div class="row colorBarContainer" id="windowing">
                        <div class="col-3">
                            <label for="ti">Window Center: </label>
                            <input type="range" class="pl-0 pr-0 form-control form-control-range" name="wc" id="wc"
                                min="0" max="4096" value="2048" onchange="displayAndWindow3DImage();" />
                        </div>
                        <div class="col-3">
                            <label for="tr">Window Width:</label>
                            <input type="range" class="pl-0 pr-0 form-control form-control-range" name="ww" id="ww"
                                min="0" max="4096" value="4096" onchange="displayAndWindow3DImage();" />
                        </div>
                        <div class="col-3">
                            <label for="slice">Slice:</label>
                            <input type="range" class="pl-0 pr-0 form-control form-control-range" min="0" max="zdim"
                                name="slice" id="r_slice" value="100" onchange="displayAndWindow3DImage();" />
                        </div>
                        <div class="">
                            <input type="button" class="btn-secondary align-self-center" value="Auto Window"
                                onclick="autoWindow()" />
                        </div>
                    </div>
                    <div class="row my-2 colorBarContainer" id="colorBarContainer">
                        <canvas class="colorBar" id="colorBar"></canvas>
                        <div class="col-3">
                            <label for="slice">Slice:</label>
                            <input type="range" class="pl-0 pr-0 form-control form-control-range" min="0" max="zdim"
                                name="slice" id="or_slice" value="100" onchange="displayAndWindow3DImage();" />
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</body>

</html>
